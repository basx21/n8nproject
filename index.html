<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gantt n8n</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.css">
<style>
  :root{--row-h:8px;--header-h:30px}
  body{font-family:Arial,Helvetica,sans-serif;margin:18px}
  h2{margin:0 0 12px 0}
  .filtro{margin-bottom:12px}
  .contenedor{display:flex;height:720px;border:1px solid #ddd}
  /* tabla izquierda: aumentada (no reduce el gantt) */
  .tabla{flex:1.6;overflow:auto;border-right:1px solid #ddd;background:#fff}
  table{width:100%;border-collapse:collapse}
  thead th{
    position:sticky;top:0;background:#fafafa;z-index:2;
    height:var(--header-h);vertical-align:middle;padding:8px 10px;font-size:14px;border-bottom:1px solid #eee;
  }
  tbody td{
    height:var(--row-h);padding:8px 10px;border-bottom:1px solid #eee;font-size:13px;white-space:nowrap;
  }
  input.percent{width:60px;border:1px solid #ccc;border-radius:4px;text-align:center;padding:2px}
  /* gantt area: mantener tamaño completo (no reducir) */
  .gantt-wrap{flex:2.4;overflow:auto;background:#fff;margin-top:-10px} /* pequeña compensación */
  .bar-wrapper{cursor:default!important}
  .gantt .grid-row, .gantt .bar-wrapper{height:var(--row-h) !important}
  .gantt .bar{rx:4; ry:4}
</style>
</head>
<body>
<h2>Diagrama de Gantt</h2>

<div class="filtro">
  <label><b>Filtrar por proyecto:</b></label>
  <select id="proyectoSelect">
    <option value="todos">Todos</option>
    <option value="Crecimiento a la campaña">Crecimiento a la campaña</option><option value="Proceso de reclutamiento">Proceso de reclutamiento</option><option value="WhatsApp transaccional">WhatsApp transaccional</option>
  </select>
</div>

<div class="contenedor">
  <div class="tabla" id="tablaContainer">
    <table id="tablaTareas">
      <thead>
        <tr>
          <th>Actividad</th>
          <th>Responsable</th>
          <th>Área</th>
          <th>Inicio</th>
          <th>Fin</th>
          <th style="text-align:center">%</th>
        </tr>
      </thead>
      <tbody id="tablaBody"></tbody>
    </table>
  </div>

  <div class="gantt-wrap" id="ganttContainer">
    <div id="gantt"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
<script>
(function(){
  const tareas = [{"id":"1","actividad":"Reclutamiento de personal","responsable":"Cristian Acevedo","area":"Area de Talento Humano","inicio_raw":"21 octubre 2025 09:00","fin_raw":"29 octubre 2025 19:00","inicio_iso":"2025-10-21","fin_iso":"2025-10-29","percent":60,"proyecto":"Crecimiento a la campaña"},{"id":"2","actividad":"Validación de perfil","responsable":"Cristian Acevedo","area":"Area de Talento Humano","inicio_raw":"30 octubre 2025 09:00","fin_raw":"31 octubre 2025 19:00","inicio_iso":"2025-10-30","fin_iso":"2025-10-31","percent":100,"proyecto":"Crecimiento a la campaña"},{"id":"3","actividad":"entrevista","responsable":"Cristian Acevedo","area":"Area de Talento Humano","inicio_raw":"3 noviembre 2025 09:00","fin_raw":"3 noviembre 2025 19:00","inicio_iso":"2025-11-03","fin_iso":"2025-11-03","percent":100,"proyecto":"Crecimiento a la campaña"},{"id":"4","actividad":"Formación corporativa","responsable":"Oscar Osorio","area":"Area Formación","inicio_raw":"4 noviembre 2025 09:00","fin_raw":"4 noviembre 2025 19:00","inicio_iso":"2025-11-04","fin_iso":"2025-11-04","percent":100,"proyecto":"Crecimiento a la campaña"},{"id":"5","actividad":"Formación en producto","responsable":"Oscar Osorio","area":"Area Formación","inicio_raw":"5 noviembre 2025 09:00","fin_raw":"11 noviembre 2025 19:00","inicio_iso":"2025-11-05","fin_iso":"2025-11-11","percent":100,"proyecto":"Crecimiento a la campaña"},{"id":"6","actividad":"Formación en herramientas","responsable":"Oscar Osorio","area":"Area Formación","inicio_raw":"12 noviembre 2025 09:00","fin_raw":"13 noviembre 2025 19:00","inicio_iso":"2025-11-12","fin_iso":"2025-11-13","percent":80,"proyecto":"Crecimiento a la campaña"},{"id":"7","actividad":"Adecuación de equipos","responsable":"Hever Orjuela","area":"Area Tecnología","inicio_raw":"4 noviembre 2025 09:00","fin_raw":"5 noviembre 2025 19:00","inicio_iso":"2025-11-04","fin_iso":"2025-11-05","percent":100,"proyecto":"Crecimiento a la campaña"},{"id":"8","actividad":"acceso a URL","responsable":"Hever Orjuela","area":"Area Tecnología","inicio_raw":"6 noviembre 2025 09:00","fin_raw":"6 noviembre 2025 19:00","inicio_iso":"2025-11-06","fin_iso":"2025-11-06","percent":100,"proyecto":"Crecimiento a la campaña"},{"id":"9","actividad":"Acceso a aplicaciones","responsable":"Hever Orjuela","area":"Area Tecnología","inicio_raw":"7 noviembre 2025 09:00","fin_raw":"7 noviembre 2025 19:00","inicio_iso":"2025-11-07","fin_iso":"2025-11-07","percent":100,"proyecto":"Crecimiento a la campaña"},{"id":"10","actividad":"Pruebas","responsable":"Hever Orjuela","area":"Area Tecnología","inicio_raw":"10 noviembre 2025 09:00","fin_raw":"10 noviembre 2025 19:00","inicio_iso":"2025-11-10","fin_iso":"2025-11-10","percent":100,"proyecto":"Crecimiento a la campaña"},{"id":"11","actividad":"Validación del BC","responsable":"Leidy Castro","area":"Area financiera","inicio_raw":"14 octubre 2025 09:00","fin_raw":"17 octubre 2025 19:00","inicio_iso":"2025-10-14","fin_iso":"2025-10-17","percent":100,"proyecto":"Crecimiento a la campaña"},{"id":"12","actividad":"Validación del modelo económico","responsable":"Leidy Castro","area":"Area financiera","inicio_raw":"20 octubre 2025 09:00","fin_raw":"20 octubre 2025 19:00","inicio_iso":"2025-10-20","fin_iso":"2025-10-20","percent":100,"proyecto":"Crecimiento a la campaña"},{"id":"13","actividad":"Aprobar modelo económico","responsable":"Leidy Castro","area":"Area financiera","inicio_raw":"21 octubre 2025 09:00","fin_raw":"21 octubre 2025 19:00","inicio_iso":"2025-10-21","fin_iso":"2025-10-21","percent":100,"proyecto":"Crecimiento a la campaña"},{"id":"1","actividad":"Reclutamiento de personal","responsable":"Cristian Acevedo","area":"Area de Talento Humano","inicio_raw":"14 octubre 2025 09:00","fin_raw":"27 octubre 2025 19:00","inicio_iso":"2025-10-14","fin_iso":"2025-10-27","percent":100,"proyecto":"Proceso de reclutamiento"},{"id":"2","actividad":"Validación de perfil","responsable":"Cristian Acevedo","area":"Area de Talento Humano","inicio_raw":"28 octubre 2025 09:00","fin_raw":"29 octubre 2025 19:00","inicio_iso":"2025-10-28","fin_iso":"2025-10-29","percent":100,"proyecto":"Proceso de reclutamiento"},{"id":"3","actividad":"entrevista","responsable":"Cristian Acevedo","area":"Area de Talento Humano","inicio_raw":"30 octubre 2025 09:00","fin_raw":"30 octubre 2025 19:00","inicio_iso":"2025-10-30","fin_iso":"2025-10-30","percent":100,"proyecto":"Proceso de reclutamiento"},{"id":"4","actividad":"Formación corporativa","responsable":"Oscar Osorio","area":"Area Formación","inicio_raw":"31 octubre 2025 09:00","fin_raw":"31 octubre 2025 19:00","inicio_iso":"2025-10-31","fin_iso":"2025-10-31","percent":50,"proyecto":"Proceso de reclutamiento"},{"id":"5","actividad":"Formación en producto","responsable":"Oscar Osorio","area":"Area Formación","inicio_raw":"3 noviembre 2025 09:00","fin_raw":"7 noviembre 2025 19:00","inicio_iso":"2025-11-03","fin_iso":"2025-11-07","percent":50,"proyecto":"Proceso de reclutamiento"},{"id":"6","actividad":"Formación en herramientas","responsable":"Oscar Osorio","area":"Area Formación","inicio_raw":"10 noviembre 2025 09:00","fin_raw":"11 noviembre 2025 19:00","inicio_iso":"2025-11-10","fin_iso":"2025-11-11","percent":50,"proyecto":"Proceso de reclutamiento"},{"id":"7","actividad":"Validación del BC","responsable":"Leidy Castro","area":"Area financiera","inicio_raw":"7 octubre 2025 09:00","fin_raw":"10 octubre 2025 19:00","inicio_iso":"2025-10-07","fin_iso":"2025-10-10","percent":10,"proyecto":"Proceso de reclutamiento"},{"id":"8","actividad":"Validación del modelo económico","responsable":"Leidy Castro","area":"Area financiera","inicio_raw":"13 octubre 2025 09:00","fin_raw":"13 octubre 2025 19:00","inicio_iso":"2025-10-13","fin_iso":"2025-10-13","percent":20,"proyecto":"Proceso de reclutamiento"},{"id":"9","actividad":"Aprobar modelo económico","responsable":"Leidy Castro","area":"Area financiera","inicio_raw":"14 octubre 2025 09:00","fin_raw":"14 octubre 2025 19:00","inicio_iso":"2025-10-14","fin_iso":"2025-10-14","percent":30,"proyecto":"Proceso de reclutamiento"},{"id":"1","actividad":"Adecuación de equipos","responsable":"Hever Orjuela","area":"Area Tecnología","inicio_raw":"11 noviembre 2025 09:00","fin_raw":"12 noviembre 2025 19:00","inicio_iso":"2025-11-11","fin_iso":"2025-11-12","percent":100,"proyecto":"WhatsApp transaccional"},{"id":"2","actividad":"acceso a URL","responsable":"Hever Orjuela","area":"Area Tecnología","inicio_raw":"13 noviembre 2025 09:00","fin_raw":"13 noviembre 2025 19:00","inicio_iso":"2025-11-13","fin_iso":"2025-11-13","percent":90,"proyecto":"WhatsApp transaccional"},{"id":"3","actividad":"Acceso a aplicaciones","responsable":"Hever Orjuela","area":"Area Tecnología","inicio_raw":"14 noviembre 2025 09:00","fin_raw":"14 noviembre 2025 19:00","inicio_iso":"2025-11-14","fin_iso":"2025-11-14","percent":80,"proyecto":"WhatsApp transaccional"},{"id":"4","actividad":"Pruebas","responsable":"Hever Orjuela","area":"Area Tecnología","inicio_raw":"17 noviembre 2025 09:00","fin_raw":"17 noviembre 2025 19:00","inicio_iso":"2025-11-17","fin_iso":"2025-11-17","percent":60,"proyecto":"WhatsApp transaccional"},{"id":"5","actividad":"Recepción de documentación","responsable":"Andres Vargas","area":"Area de Desarrllo","inicio_raw":"13 noviembre 2025 09:00","fin_raw":"13 noviembre 2025 19:00","inicio_iso":"2025-11-13","fin_iso":"2025-11-13","percent":90,"proyecto":"WhatsApp transaccional"},{"id":"6","actividad":"desarrollo y automatización","responsable":"Andres Vargas","area":"Area de Desarrllo","inicio_raw":"14 noviembre 2025 09:00","fin_raw":"27 noviembre 2025 19:00","inicio_iso":"2025-11-14","fin_iso":"2025-11-27","percent":50,"proyecto":"WhatsApp transaccional"},{"id":"7","actividad":"Pruebas","responsable":"Andres Vargas","area":"Area de Desarrllo","inicio_raw":"28 noviembre 2025 09:00","fin_raw":"28 noviembre 2025 19:00","inicio_iso":"2025-11-28","fin_iso":"2025-11-28","percent":29,"proyecto":"WhatsApp transaccional"},{"id":"8","actividad":"Ajustes (si aplica)","responsable":"Andres Vargas","area":"Area de Desarrllo","inicio_raw":"1 diciembre 2025 09:00","fin_raw":"1 diciembre 2025 19:00","inicio_iso":"2025-12-01","fin_iso":"2025-12-01","percent":20,"proyecto":"WhatsApp transaccional"},{"id":"9","actividad":"Salida a producción","responsable":"Andres Vargas","area":"Area de Desarrllo","inicio_raw":"2 diciembre 2025 09:00","fin_raw":"2 diciembre 2025 19:00","inicio_iso":"2025-12-02","fin_iso":"2025-12-02","percent":23,"proyecto":"WhatsApp transaccional"},{"id":"10","actividad":"Validación del BC","responsable":"Leidy Castro","area":"Area financiera","inicio_raw":"4 noviembre 2025 09:00","fin_raw":"7 noviembre 2025 19:00","inicio_iso":"2025-11-04","fin_iso":"2025-11-07","percent":100,"proyecto":"WhatsApp transaccional"},{"id":"11","actividad":"Validación del modelo económico","responsable":"Leidy Castro","area":"Area financiera","inicio_raw":"10 noviembre 2025 09:00","fin_raw":"10 noviembre 2025 19:00","inicio_iso":"2025-11-10","fin_iso":"2025-11-10","percent":100,"proyecto":"WhatsApp transaccional"},{"id":"12","actividad":"Aprobar modelo económico","responsable":"Leidy Castro","area":"Area financiera","inicio_raw":"11 noviembre 2025 09:00","fin_raw":"11 noviembre 2025 19:00","inicio_iso":"2025-11-11","fin_iso":"2025-11-11","percent":100,"proyecto":"WhatsApp transaccional"}];
  const colores = {
    "Area de Talento Humano":"#2E86C1",
    "Area financiera":"#1ABC9C",
    "Area Formación":"#F4D03F",
    "Area Tecnología":"#E67E22",
    "Area de Desarrllo":"#9B59B6",
    "":"#95A5A6"
  };

  const proyectoSelect = document.getElementById('proyectoSelect');
  const tablaBody = document.getElementById('tablaBody');
  const tablaContainer = document.getElementById('tablaContainer');
  const ganttContainer = document.getElementById('ganttContainer');
  let listaActual = tareas.slice();

  function renderTabla(list){
    tablaBody.innerHTML = list.map(t => `
      <tr data-id="${t.id}">
        <td>${t.actividad}</td>
        <td>${t.responsable}</td>
        <td>${t.area}</td>
        <td>${t.inicio_raw}</td>
        <td>${t.fin_raw}</td>
        <td style="text-align:center"><input class="percent" data-id="${t.id}" type="number" min="0" max="100" value="${t.percent}">%</td>
      </tr>`).join('');
    document.querySelectorAll('.percent').forEach(inp=>{
      inp.addEventListener('change', e=>{
        const id = e.target.dataset.id;
        const val = Math.min(100, Math.max(0, Number(e.target.value || 0)));
        const tarea = tareas.find(x=>x.id===id);
        if(tarea){ tarea.percent = val; renderGantt(); }
      });
    });
  }

  function buildFrappeTasks(list){
    return list.filter(t => t.inicio_iso && t.fin_iso).map(t => ({
      id: t.id,
      name: t.actividad,
      start: t.inicio_iso,
      end: t.fin_iso,
      progress: t.percent,
      custom_class: 'area-' + (t.area || '').replace(/\s+/g,'_')
    }));
  }

  function renderGantt(){
    const tasks = buildFrappeTasks(listaActual);
    document.getElementById('gantt').innerHTML = '';
    const gantt = new Gantt("#gantt", tasks, {
      view_mode: 'Day',
      bar_height: 29,
      padding: 10,
      language: 'es',
      on_click: ()=>{},
      on_date_change: ()=>{},
      on_progress_change: ()=>{},
      custom_popup_html: task => {
        const original = listaActual.find(x => String(x.id) === String(task.id));
        return `<div style="padding:8px">
          <strong>${task.name}</strong><br>
          Responsable: ${original ? original.responsable : ''}<br>
          Área: ${original ? original.area : ''}<br>
          Inicio: ${original ? original.inicio_raw : ''}<br>
          Fin: ${original ? original.fin_raw : ''}<br>
          Avance: ${task.progress}%
        </div>`;
      }
    });

    setTimeout(()=>{ document.querySelectorAll('.bar-wrapper').forEach(el=>el.style.pointerEvents='none'); }, 80);
    setTimeout(()=>{
      listaActual.forEach(t=>{
        if(!t.inicio_iso||!t.fin_iso) return;
        const cls = 'area-' + (t.area || '').replace(/\s+/g,'_');
        const color = colores[t.area] || '#7f8c8d';
        document.querySelectorAll('.' + cls + ' .bar').forEach(el => el.style.fill = color);
        document.querySelectorAll('.' + cls + ' .progress').forEach(pe => pe.style.fill = shadeColor(color, -25));
      });
    }, 150);
  }

  function shadeColor(color, percent){
    const num = parseInt(color.replace("#",""),16);
    const amt = Math.round(2.55 * percent);
    const R = (num >> 16) + amt;
    const G = (num >> 8 & 0x00FF) + amt;
    const B = (num & 0x0000FF) + amt;
    return "#" + (0x1000000 + (R<255? (R<0?0:R):255)*0x10000 + (G<255? (G<0?0:G):255)*0x100 + (B<255? (B<0?0:B):255)).toString(16).slice(1);
  }

  proyectoSelect.addEventListener('change', ()=> {
    const sel = proyectoSelect.value;
    listaActual = sel === 'todos' ? tareas.slice() : tareas.filter(t => t.proyecto === sel);
    renderTabla(listaActual);
    renderGantt();
  });

  // sincronizar scroll verticalmente
  let syncingFromTable = false;
  let syncingFromGantt = false;
  tablaContainer.addEventListener('scroll', ()=> {
    if(syncingFromGantt) { syncingFromGantt = false; return; }
    syncingFromTable = true;
    ganttContainer.scrollTop = tablaContainer.scrollTop;
    setTimeout(()=> syncingFromTable = false, 50);
  });
  ganttContainer.addEventListener('scroll', ()=> {
    if(syncingFromTable) { syncingFromTable = false; return; }
    syncingFromGantt = true;
    tablaContainer.scrollTop = ganttContainer.scrollTop;
    setTimeout(()=> syncingFromGantt = false, 50);
  });

  // inicial
  renderTabla(listaActual);
  renderGantt();
  window.__n8nGantt = { tareas, renderTabla, renderGantt };
})();
</script>
</body>
</html>